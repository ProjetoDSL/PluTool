# For more information: https://laravel.com/docs/sail
version: '3'
services:
    app:
        build: .
        volumes:
            - '.:/var/www/html/tools/plutool'
        working_dir: /var/www/html/tools/plutool
        ports:
            - '8000:80'
        extra_hosts:
            - "plutool:127.0.0.1"
        networks:
            - sail
        links:
            - db
        environment:
          - TZ=America/Sao_Paulo
          - MYSQL_HOST=db
        command: >
            bash -c "composer install &&
            composer update &&
            composer dumpautoload &&
            php artisan migrate:fresh --seed &&
            npm install &&
            npm run ${APP_ENV} &&
            apachectl -D FOREGROUND"
        depends_on:
            - db
    db:
        image: 'mysql:8.0'
        restart: always
        ports:
            - '${FORWARD_DB_PORT:-3306}:3306'
        environment:
            MYSQL_ROOT_PASSWORD: 'plutool'
            MYSQL_DATABASE: 'plutool'
            MYSQL_USER: '${DB_USERNAME}'
            MYSQL_PASSWORD: '${DB_PASSWORD}'
        volumes:
            - 'sailmysql:/var/lib/mysql'
        networks:
            - sail
        healthcheck:
          test: ["CMD", "mysqladmin", "ping"]
    phpmyadmin:
        image: phpmyadmin
        restart: always
        ports:
          - 8080:80
        environment:
          - PMA_ARBITRARY=1
        depends_on:
          - db
        networks:
          - sail
    mailhog:
        image: 'mailhog/mailhog:latest'
        ports:
            - '${FORWARD_MAILHOG_PORT:-1025}:1025'
            - '${FORWARD_MAILHOG_DASHBOARD_PORT:-8025}:8025'
        networks:
            - sail
networks:
    sail:
        driver: bridge
volumes:
    sailmysql:
        driver: local
